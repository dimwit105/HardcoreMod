package com.blaxout1213.dayz.managers;

import java.util.Random;

import net.minecraft.block.Block;
import net.minecraft.entity.DataWatcher;
import net.minecraft.entity.EntityLivingBase;
import net.minecraft.entity.SharedMonsterAttributes;
import net.minecraft.entity.monster.EntityZombie;
import net.minecraft.entity.player.EntityPlayer;
import net.minecraft.entity.player.EntityPlayerMP;
import net.minecraft.init.Blocks;
import net.minecraft.item.Item;
import net.minecraft.item.ItemStack;
import net.minecraft.potion.Potion;
import net.minecraft.potion.PotionEffect;
import net.minecraft.util.ChatComponentTranslation;
import net.minecraft.util.MathHelper;
import net.minecraft.world.World;
import net.minecraft.world.biome.BiomeGenBase;
import net.minecraft.world.chunk.Chunk;

import com.blaxout1213.dayz.CustomPotion;
import com.blaxout1213.dayz.DayzMod;
import com.blaxout1213.dayz.ExtendedPlayer;
import com.blaxout1213.dayz.PlayerStalker;
import com.blaxout1213.dayz.UtilMisc;
import com.blaxout1213.entity.EntityCorruptedZombie;

public class EverythingManager 
{
	private int posY;
	private int posX;
	private int posZ;
	private int range;
	private int healthCD;
	public int daycheck;
	private Random rand;
    private void generateRandomParticles(String par1Str, EntityPlayer ep)
    {
        for (int i = 0; i < 5; ++i)
        {
            double d0 = this.rand.nextGaussian() * 0.02D;
            double d1 = this.rand.nextGaussian() * 0.02D;
            double d2 = this.rand.nextGaussian() * 0.02D;
            ep.worldObj.spawnParticle(par1Str, this.posX + (double)(this.rand.nextFloat() * ep.width * 2.0F) - (double)ep.width, this.posY + 1.0D + (double)(this.rand.nextFloat() * ep.height), this.posZ + (double)(this.rand.nextFloat() * ep.width * 2.0F) - (double)ep.width, d0, d1, d2);
        }
    }
	public void onUpdate(EntityPlayer ep, World w)
	{
		this.rand = new Random();
		//Minecraft mc = Minecraft.getMinecraft();
		World world = ep.worldObj;
		DataWatcher dw = ep.getDataWatcher();
		ExtendedPlayer props = ExtendedPlayer.get((EntityPlayer) ep);
		Object time = dw.getWatchableObjectInt(21) - 1;
		EntityPlayer player = (EntityPlayer) ep;
		posX = (int)ep.posX;
		posY = (int)ep.posY;
		posZ = (int)ep.posZ;
		int x = MathHelper.floor_double(ep.posX);
		int y = MathHelper.floor_double(ep.posY);
		int z = MathHelper.floor_double(ep.posZ);
		Chunk chunk = ep.worldObj.getChunkFromBlockCoords(x, z);
		//String biome = chunk.getBiomeGenForWorldCoords((int)ep.posX & 15, (int)ep.posZ & 15, mc.theWorld.getWorldChunkManager()).biomeName;
		Block blockID = ep.worldObj.getBlock(posX, posY, posZ);
		Block blockID2 = ep.worldObj.getBlock(posX, posY - 1, posZ);
		BiomeGenBase biomegenbase2 = ep.worldObj.getWorldChunkManager().getBiomeGenAt(posX, posZ);
		BiomeGenBase biome = chunk.getBiomeGenForWorldCoords(x & 15, z & 15, ep.worldObj.getWorldChunkManager());
		//biome4 = biome;
		//temptimer ++;
		healthCD --;
		int wellness = dw.getWatchableObjectInt(27);
		//ep.getEntityAttribute(SharedMonsterAttributes.maxHealth).getBaseValue();
		if(ep.getHealth() > ep.getMaxHealth())
		{
			ep.setHealth(ep.getMaxHealth());
		}
		if(props.brokenLeg("get", 0) > 0)
		{
			int power = Math.min(props.brokenLeg("get", 0) / 6000, 4);
			((EntityLivingBase)ep).addPotionEffect(new PotionEffect(Potion.moveSlowdown.id, 25 , power));
			props.brokenLeg("subtract", 1);
		}
		double speedAdjustment = (double)dw.getWatchableObjectInt(27) / 10;
		double speed = ep.getEntityAttribute(SharedMonsterAttributes.movementSpeed).getAttributeValue() * speedAdjustment;
        if (!w.isRemote)
        {
    		ep.getEntityAttribute(SharedMonsterAttributes.maxHealth).setBaseValue((double) wellness * 2);
    		ep.getEntityAttribute(SharedMonsterAttributes.movementSpeed).setBaseValue(speed);
        }
		if(wellness > 15)
		{
			dw.updateObject(27, dw.getWatchableObjectInt(27) - 1);
		}
		if(wellness < 3)
		{
			dw.updateObject(27, dw.getWatchableObjectInt(27) + 1);
		}
		if(UtilMisc.isKO(ep))
		{
			UtilMisc.dropCertainItems(ep.inventory, "main");
		}
		if(!UtilMisc.isKO(ep) && props.bleed("get", 0) == 0 && ep.getFoodStats().getFoodLevel() > 0 && ep.ticksExisted % 1200 <= 10 && healthCD < 0 && !w.isRemote)
		{
			//dw.updateObject(27, dw.getWatchableObjectInt(27) + 1);
			ep.heal(1F);
			healthCD = 50;
		}
		if(rand.nextInt(300) == 0)
		{
			//w.playSound(x, y, z, "dayz:razorsharp", 1F, 1F, false);
		}
		dw.updateObject(21, time);
		if(props.nether("get", true))
		{
			if(UtilMisc.getMoonPhase(world.getWorldTime()) != 4)
			{
				props.nether("set", false);
			}
		}
		if(ep.getDataWatcher().getWatchableObjectInt(26)/20 > (int)ep.getHealth())
		{
			this.generateRandomParticles("snowshovel", ep);
		}
		if((world.getWorldTime() % 60 <= 2) && dw.getWatchableObjectInt(26) > 0 && !world.isRemote)
		{
			dw.updateObject(26, dw.getWatchableObjectInt(26) - 1);
		}
		if(!ep.worldObj.isRemote)
		{
			if(ep.worldObj.getWorldTime() % 20 == 0)
			{
				EntityPlayerMP player1 = (EntityPlayerMP) ep;
				props.sync(player1);
				//System.out.println("Update");
			}

		}
		if(dw.getWatchableObjectInt(25) > 0)
		{
			float rndX = (((EntityLivingBase) ep).getRNG().nextFloat() * ep.width * 2) - ep.width;
			float rndY = ((EntityLivingBase) ep).getRNG().nextFloat() * ep.height;
			float rndZ = (((EntityLivingBase) ep).getRNG().nextFloat() * ep.width * 2) - ep.width;
			rndY = -rndY;
			ep.worldObj.spawnParticle("dripWater", ep.posX + rndX, ep.posY + rndY, ep.posZ + rndZ, 0.0D, 0D, 0.0D);
		}
		// -2, 2
		// -3, 3
		// -1, 1
		//resistanceTimer ++;
		/*
		if(props.fire("get", false) == true)
		{
			healz++;
			if(healz >= 300)
			{
				player.heal(1F);
				healz = 0;
			}
		}
		
		if(UtilMisc.isPlayerWalking(ep))
		{
			ItemStack boots = ep.inventory.armorItemInSlot(3);
			if(boots != null)
			{
				props.feetHealth("subtract", 1);
				boots.damageItem(1, ep);
			}
			else if(blockID2 != Blocks.air)
			{
				if(blockID2 == Blocks.bedrock || blockID2 == Blocks.netherrack)
				{
					props.feetHealth("subtract", 3);
				}
				else if(blockID2 == Blocks.grass || blockID2 == Blocks.dirt || blockID2 == Blocks.stone)
				{
					props.feetHealth("subtract", 2);
				}
				else
				{
					props.feetHealth("subtract", 1);
				}
			}
			
		}
		*/
		if(props.badBlood("get", true) && !ep.isPotionActive(CustomPotion.badblood))
		{
			((EntityLivingBase)ep).addPotionEffect(new PotionEffect(CustomPotion.badblood.id, 3600 ,0));
		}
		if(props.bleed("get", 0) > 0)
		{
			props.bleedout("add", 1);
			if(ep.ticksExisted % 100 == 0)
			{
				ep.attackEntityFrom(DayzMod.bleed, props.bleed("get", 0));
				props.bleed("subtract", 1);
				if(props.bleed("get", 0) == 0 && !ep.worldObj.isRemote)
				{
					
					((EntityPlayer) ep).addChatComponentMessage(new ChatComponentTranslation("bleed.clot" + rand.nextInt(3), new Object[0]));
				}
			}
		}

		props.wellnessCD("subtract", 1);
		if(dw.getWatchableObjectFloat(22) < 0.2F && ep.worldObj.getWorldTime() % 1200 == 0)
		{
			dw.updateObject(22, dw.getWatchableObjectFloat(22) + 0.01F);
		}
		if(dw.getWatchableObjectFloat(22) < 0F)
		{
			dw.updateObject(22, 0);
		}

		if(dw.getWatchableObjectInt(25) < -1)
		{
			dw.updateObject(25, 0);
		}
		
		if(dw.getWatchableObjectInt(25)/20 > 300)
		{
			int power = Math.min(((dw.getWatchableObjectInt(25)/20) / 300) - 1, 4);
			((EntityLivingBase)ep).addPotionEffect(new PotionEffect(Potion.moveSlowdown.id, 300 ,power));
			((EntityLivingBase)ep).addPotionEffect(new PotionEffect(Potion.digSlowdown.id, 300 ,power));
			if(dw.getWatchableObjectInt(25)/20 > 500)
			{
				if(ep.worldObj.getWorldTime() % 1200 == 0 && player.getHealth() > 0)
				{
					dw.updateObject(22, dw.getWatchableObjectFloat(22) - 0.02F * (power + 1));
					float damage = Math.min((dw.getWatchableObjectInt(25)/20) / 100, player.getHealth() - 1);
					ep.attackEntityFrom(DayzMod.wet, damage);
				}
			}
		}
		
		/*
		if(dw.getWatchableObjectFloat(22) >= 0.2F)
		{
			resistanceAdd ++;
			if(resistanceAdd >= 3600 && dw.getWatchableObjectFloat(22) <= 0.45F)
			{				
				dw.updateObject(22, dw.getWatchableObjectFloat(22) + 0.01F);
				resistanceAdd = 0;
			}
		}
		*/
		if(dw.getWatchableObjectInt(21) < -300)
		{
			dw.updateObject(21, -20);
		}
		if(dw.getWatchableObjectInt(20) == 1)
		{
			if(dw.getWatchableObjectInt(21) <= 0)
			{
				ep.attackEntityFrom(DayzMod.venom, 1000);
				dw.updateObject(20, 0);
				dw.updateObject(21, 0);
			}
		}
		if(dw.getWatchableObjectInt(20) == 2)
		{
			if(dw.getWatchableObjectInt(21) <= 0 && rand.nextFloat() > dw.getWatchableObjectFloat(22))
			{
				ep.attackEntityFrom(DayzMod.venom, 1000);
				dw.updateObject(20, 0);
				dw.updateObject(21, 0);
			}
			else if(dw.getWatchableObjectInt(21) <= 0)
			{
				((EntityLivingBase)ep).addPotionEffect(new PotionEffect(Potion.moveSlowdown.id, 3600 ,3));
				((EntityLivingBase)ep).addPotionEffect(new PotionEffect(Potion.digSlowdown.id, 3600 ,3));
				((EntityLivingBase)ep).addPotionEffect(new PotionEffect(Potion.weakness.id, 3600 ,3));
				dw.updateObject(20, 0);
				dw.updateObject(21, 0);
				dw.updateObject(22, dw.getWatchableObjectFloat(22) + 0.03F);
			}
		}
		if(dw.getWatchableObjectInt(20) == 3)
		{
			if(dw.getWatchableObjectInt(21) <= 0 && (rand.nextFloat() - 0.5F) > dw.getWatchableObjectFloat(22))
			{
				ep.attackEntityFrom(DayzMod.venom, 1000);
				dw.updateObject(20, 0);
				dw.updateObject(21, 0);
			}
			else if(dw.getWatchableObjectInt(21) <= 0)
			{
				((EntityLivingBase)ep).addPotionEffect(new PotionEffect(Potion.moveSlowdown.id, 2400 ,2));
				((EntityLivingBase)ep).addPotionEffect(new PotionEffect(Potion.digSlowdown.id, 2400 ,2));
				((EntityLivingBase)ep).addPotionEffect(new PotionEffect(Potion.weakness.id, 2400 ,1));
				dw.updateObject(20, 0);
				dw.updateObject(21, 0);
				dw.updateObject(22, dw.getWatchableObjectFloat(22) + 0.01F);
			}
		}
		if(dw.getWatchableObjectInt(20) == 4)
		{
			if(dw.getWatchableObjectInt(21) <= 0)
			{
				ep.attackEntityFrom(DayzMod.zombieInfection, 1000);
				dw.updateObject(20, 0);
				dw.updateObject(21, 0);
				EntityCorruptedZombie ez1 = new EntityCorruptedZombie(world);
				ez1.setPosition(x, y, z);
				world.spawnEntityInWorld(ez1);
			}
		}
	}
}
